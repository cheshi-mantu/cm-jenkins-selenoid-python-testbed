# Сборка тестового стенда на Jenkis + python, Selenoid, Selenoid UI, Chrome browser

## Предварительные условия

1. Железный сервер или виртуальная машина
2. Приложение эмулятор терминала
3. VSCode (текстовый редактор, правка удаленных файлов)

Пример делается на Ubuntu и в целом должен работать для debian линуксов.

### Windows

Нормальный терминал и команды линукс работают в приложении GitBash, которое входит в состав [Git for Windows.](https://git-scm.com/download/win)

## Подготовка

Работаем с аутентификацией по паре публичный + приватный ключ.

### Как работать с ssh на локальной машине

Для Windows, например, запускаем git bash на локальной windows машине, для макос — терминал

В git bash проверяем, есть ли у нас папка .ssh и что в ней лежит

```bash
ls -l ~/.ssh | grep id_rsa
```

Если пусто, то ключей у нас нет. Если ключи есть то увидим, что в папке лежат `id_rsa`, `id_rsa.pub`

Создадим пару ключей

```bash
ssh-keygen -t rsa -b 4096 -C `<email.address@email.xyz>`
```

`<email.address@email.xyz>` замените на что-то свое. Это комментарий, который вам позволит понять, к чему относится этот ключ.

Проверим, работает ли у нас ssh агент

```shell
eval $(ssh-agent -s)
```
Должны увидеть Process ID (PID) агента.

Добавим ключи ssh агенту

```shell
ssh-add ~/.ssh/id_rsa
```

Теперь с ними можно работать.

### Как добавить публичный ключ на удаленную машину

Если это хостинг, то, как правило, есть вариант скопировать туда публичный ключ и он везде будет добавляться.

Если нет, то копируем наш ключ на удаленную машину:

```shell
ssh-copy-id root@host-address-or-IP
```

### файл конфигов на локальной машине

Зачем: немного сэкономить время на вводе команд, чтобы вместо `ssh root@192.168.1.10` использовать `ssh test-bed`.

Лейбл запомнить легче, чем IP адрес.

заходим в папку с файлами ssh и запускаем VSCode. 

```shell
cd ~/.ssh
code .
```

если нет файла config, то создаем его, если есть — открываем

добавляем запись

```shell
Host test-bed
    Hostname 192.168.1.10
    User root
    Port 22
```

Теперь к удаленному серверу можно подключиться набрав в терминале `ssh test-bed`

## Начальные действия на удаленной машине

### Обновить репы, обновить бинарники, установить MC

```shell
apt update && apt upgrade -y && apt install mc
```

### Какая командная оболочка используется

```shell
echo $0
```

#### Поменять командную оболочку

Если не устраивает та, что используется по умолчанию.

```shell
chsh -s /bin/bash
```

### Установить докер

Самый ленивый способ — скриптом с сайта

```shell
curl -sSL https://get.docker.com | sh
```

## Готовим стенд

## Папочки

Переходим в /opt, клонируем текущий репозиторий, переобзываем это дело

```shell
cd /opt
git clone https://github.com/cheshi-mantu/cm-jenkins-selenoid-python-testbed.git
mv cm-jenkins-selenoid-python-testbed test-bed
cd test-bed
```

## Что в папках и зачем

`./image/Dockerfile`

Файл описывает, как нам надо поменять образ докера с дженкинсом, который мы хотим использовать.

Мы внутри добавляем питон, а также питоньи библиотеки.

`./init/selenoid`

Содержит файл `browsers.json` с описанием образов браузеров (название, версия, ссылка на образ), которые будут использоваться селеноидом.

`./work/jenkins` — рабочая папка дженкинса, куда будет происходить маппинг рабочих папок деженкинса внутри контейнера. Просто для удобства, чтобы иметь к ним доступ с локальной машины.
`./work/selenoid` — рабочая папка селеноида, куда будет происходить маппинг рабочих папок селеноида внутри контейнера.Просто для удобства, чтобы иметь к ним доступ с локальной машины.

`./docker-compose.yml` — описание сервисов и их настроек.

### Особенности сервиса Jenkins

Т.к. мы хотим, чтоб образ с дженкинсом еще и позволял нам гонять питонские тесты без агентов с питоном, мы должны такой образ собрать прямо на месте. Это делается так:

Удаляем (комментируем ссылку на исходный образ)

```yaml
#image: jenkins/jenkins:lts
```

добавляем директиву build

```yaml
    build:
      context: ./image
```

Компоуз возьмет Dockerfile из папки ./image соберет новый образ и создаст контейнер на его основе.


## Запуск стенда

```shell
docker compose up -d
```

